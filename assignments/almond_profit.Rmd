---
title: "Almond Yield Assignment"
authors: "Luna Hershenfeld-Catalan & Sofia Ingersoll"
date: "2024 April 12"
output:
  slidy_presentation:
    highlight: pygments
  html_document: default
  pdf_document: default
  ioslides_presentation:
    highlight: pygments
  beamer_presentation:
    highlight: pygments
---
# Instructions 
In your same groups - 

+ Develop a profit model for your almond yield (you can make this up - think about what the parameters would be)

      * you might assume a baseline profit and then adjust according to the anomaly  

     * there are many ways to combine the almond yield and profit functions; you can have the profit function "call"/use the almond yield function; or create a wrapper function that calls them in sequence (first the almond yield and then the profit function) 

+ Do a simple informal sensitivity analysis of almond yield profit using at least 2 parameters

+ Create 2 graphs of the results - you can decide what is the most meaningful graph 

* Write a short paragraph (in the Rmarkdown document) to summarize you interpretation of your model results (e.g what do 'take away' from your model and sensitivity analysis)

# Code

### Set up
```{r message = FALSE}
# chunk settings
knitr::opts_chunk$set(echo = TRUE#, message = FALSE, warning = FALSE
                      )
# libraries
library(tidyverse)
library(here)

# load data
clim <- read.delim(here('assignments','clim.txt'),
                   header = TRUE,
                   sep = " ")
```

### Wrangle Monthly Data
```{r}
# Calculate monthly average minimum and maximum temperatures
monthly_clim <- clim %>%
  # this order was selected so we can easily access the previous month's total precip
  group_by(year, month) %>%
  summarize(avg_tmin_c = mean(tmin_c),
            total_precip = sum(precip))

head(monthly_clim)
```

 # Almond Yield Function
```{r}
#' computes yield from min. monthly temp and last months total precip
#' @param  T_min (C)
#' @param  P (mm)
#' @param  year (yr)
#' @param  month (dy)
#' @return data frame with estimate of yield

almond_func <- function(df){
  
  yields <- data.frame()
  
  # iterate over the rows to get yields
  for(date in 1:nrow(df)) {
    
    T_min = df$avg_tmin_c[date]
    
    # Use the previous month's precipitation
    if (date > 1) {
      P <- df$total_precip[date - 1]
    } 
    # If there's no previous month, set precipitation to NA
    else {
      P <- NA  
    }
    
   # Get the year and month for the current row
    Year <- df$year[date]
    Month <- df$month[date]
    
    Y_min = (-0.015*T_min) - (0.0046*(T_min**2)) - (0.07*P) + (0.0043*(P^2)) + 0.28
    
    calculations <- data.frame(Year = Year,
                               Month = Month,
                               Y_min = Y_min)
    
    yields <-  rbind(yields, calculations)
  }
  
  yield_summary <- data.frame(
    Ymax = max(na.omit(yields$Y_min)),
    Ymin = min(na.omit(yields$Y_min)),
    Ymean = mean(na.omit(yields$Y_min))
  )
  
  return(list(yield_summary, yields))
}
```
 
### Testing Updated Function
```{r}
almond_func(monthly_clim)
```
 
# Profit Yield Function

```{r}
#' computes profit from power generation
#' @param  price ($/kj)
#' @param  energy (kj/yr)
#' @param  year (when was energy obtained)
#' @param discount rate (default 0.12)
#' @return data frame with estimate of profit
compute_profit_frompower = function(energy, year, price, discount=0.12) {

  # make sure values are reasonable
  if (length(energy) < 1)
    return(NA)
  
  # energy cannot be negative
  if (min(energy ) < 0)
    return(NA)
  
  # generate a unique identifier or scenario number
  scen = seq(from=1, to=length(energy))
  yearprofit = data.frame(scen=scen, energy=energy, year=year)
  yearprofit$net =  yearprofit$energy*price

  # note how discount is passed through to this function
  # remember to normalize the year to start year e.g the first year
  yearprofit= yearprofit %>% 
      mutate(netpre = compute_NPV(value=net, time=year-year[1], discount=discount ))
  
  return(yearprofit)
}
```

# Net Present Value Function (NPV)
```{r}
#' compute_NPV
#' 
#' compute net present value
#' @param value/cost ($)
#' @param time in the future that cost/value occurs (years)
#' @param discount rate 
#' @return value in $


compute_NPV = function(value, time, discount=0.12) {
	result = value / (1 + discount)**time
	return(result)
}
```


# Sensitivty Analysis on 2 Parameters
**pulling from  `InformalSensitivity2.Rmd``**
### mapping parameters
```{r}
# FROM DRAFT RMD

```

```{r}
#. FROM CLASS
# generate samples for both parameters
nsamples = 300
deviation = 0.15
base_thresh = 10000
ethresh = runif(min=base_thresh-deviation*base_thresh,
                max = base_thresh+deviation*base_thresh, n=nsamples)

eff = rnorm(mean=0.6, sd = 0.1, n=nsamples)

parms = cbind.data.frame(eff, ethresh)

# use pmap 
# takes function name and then names of all parameters that don't change
results = parms %>% pmap(solarpv,  area=0.1, 
                         solar=sierraczosolar, clr="green",
                         eunit="W", g=FALSE, etype="direct")

results[[1]]
length(results)

# now we can extract results from the list as above
mean_elect = map_df(results,`[`, c("mean")) 
# and we can add the parameter values for each run
mean_elect = cbind.data.frame(mean_elect, parms)

# plot - pick on of the 2 parameter as a color

p1 = ggplot(mean_elect, aes(ethresh, mean, col=eff))+geom_point(cex=2)+
  labs(y="Mean Annual Electricity W", x="Threshold Radiation (kJ/m2)  \n above which energy production is more efficient")

p2 = ggplot(mean_elect, aes(eff, mean, col=ethresh))+geom_point(cex=2)+
  labs(y="Mean Annual Electricity W", x="Efficiency")
ggarrange(p1,p2)

# what do we learn from this

# extract annual 
tmp = map_df(results,`[`, c("annual")) 
annual_elect = as.data.frame(tmp$annual$year)
colnames(annual_elect)="year"
annual_elect$elect = tmp$annual$elect
```

### Visual 1
```{r}
# boxplot
ggplot(site2df, 
       aes(as.factor(year),elect, group=year))+
  geom_boxplot()+
  labs(y="Electricity generated in W", x="Year")

```

### Visual 2
```{r}

```

### Visual 3
```{r}

```

