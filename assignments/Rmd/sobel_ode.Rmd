---
title: "Sobol ODE Assignment"
authors: "Luna Hershenfeld-Catalan"
date: "2024 May 7th"
output: html
---

Task
# 1. Implement model in R

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(deSolve)
# for sobel
library(sensitivity)
```

Create the model as a function:
```{r eval = FALSE}
dforestgrowth = function(Time, C, parms) {
  
  if(C < 50) { # the canopy threshold
    
    dG = parms$r * C
  } else {
    
    dG = parms$r * C * (1- C/parms$K)
  }
  
  return(list(dG))
}
```


```{r}
# read in the function
source("../../R/dforestgrowth.R")

```


# 2. Run model for 300 years (using ODE solver)

Initial conditions
- initial forest size of 10 kg/C
- canopy closure threshold of 50 kgC
- K = 250 kg C (carrying capacity)
- r= 0.01 (exponential growth rate before before canopy closure)
- g = 2 kg/year (linear growth rate after canopy closure)

```{r}
# initial forest size
Cinitial = 10
thresh = 50
# K = 250
# r = 0.01
# g = 2

# generate the sobel parameters
np=2000
K = rnorm(mean=250, sd=250*0.01, n=np)
r = rnorm(mean=0.01, sd=0.01*0.01, n=np)
g = rnorm(mean = 2, sd = 2*0.01, n = np)
X1 = cbind.data.frame(r=r, K=K, g = g)

# repeat to get our second set of samples
K = rnorm(mean=250, sd=250*0.01, n=np)
r = rnorm(mean=0.01, sd=0.01*0.01, n=np)
g = rnorm(mean = 2, sd = 2*0.01, n = np)
X2 = cbind.data.frame(r=r, K=K, g = g)

# fix any negative values and they are not meaningful
X1 = X1 %>% map_df(pmax, 0.0)
X2 = X2 %>% map_df(pmax, 0.0)

# run sobel model
sens_P = sobolSalt(model = NULL,X1, X2, nboot = 300)

# lets add names 
colnames(sens_P$X) = c("r","K", "g")

```


Get results for 300 years
```{r}
# gets results for 200 years (evaluating every year)
simtimes = seq(from=1, to=300)
parms = list(r=sens_P$X[1,"r"], 
             K=sens_P$X[1,"K"], 
             g=sens_P$X[1,"g"])

# run the ODE solver with these conditions
result = ode(y=Cinitial, 
             times=simtimes,
             func=dforestgrowth, # growth function
             parms=parms)

# rename the column names
colnames(result)=c("time","C")
```


# 3. Graph Results
```{r}
ggplot(result, aes(time, C)) +
  geom_point() +
  theme_classic()
```


# 4. Run sobol global

Sensitivity analysis that explores how the estimated maximum forest size (e.g maximum of C 300 years), varies with these parameters


- pre canopy closure growth rate (r)
- post-canopy closure growth rate (g)
- canopy closure threshold and carrying capacity(K)

# 5. Graph results of sensitivity analysis as a box plot of maximum forest size and record the two Sobol indices (S and T).

# 6. Discuss meaning of results of simulation (For example think about how what parameters climate change might influence).